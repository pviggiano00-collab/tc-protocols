<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generatore Protocolli TC ‚Äì Desio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');
:root {
  --bg:#0f1117; --surface:#1a1d27; --surface2:#22263a; --border:#2e3350;
  --accent:#4f8ef7; --accent2:#38d9a9; --text:#e8ecf4; --muted:#7a82a0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column;}
header{padding:20px 36px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:var(--surface);}
.logo{width:34px;height:34px;background:var(--accent);border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:13px;color:#fff;}
header h1{font-size:17px;font-weight:600;}
header .sub{font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
.badge{margin-left:auto;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;color:var(--accent2);font-family:'IBM Plex Mono',monospace;}
main{flex:1;padding:36px;max-width:1050px;margin:0 auto;width:100%;}
.step-label{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;}
.step h2{font-size:19px;font-weight:500;margin-bottom:14px;}
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:44px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface);position:relative;}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:var(--surface2);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:38px;margin-bottom:10px;}
.upload-zone p{color:var(--muted);font-size:13px;}
.upload-zone strong{color:var(--accent);}
.btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:11px 26px;font-size:13px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;transition:all .15s;display:inline-flex;align-items:center;gap:7px;}
.btn:hover{background:#3a7ae8;transform:translateY(-1px);}
.btn-sec{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.btn-sec:hover{background:var(--border);}
.btn-green{background:#2a7a5a;} .btn-green:hover{background:#236b4d;}
#status{margin-top:14px;padding:11px 15px;border-radius:8px;font-size:12px;font-family:'IBM Plex Mono',monospace;display:none;}
#status.info{background:#1a2a4a;border:1px solid var(--accent);color:var(--accent);display:block;}
#status.success{background:#1a3a2a;border:1px solid var(--accent2);color:var(--accent2);display:block;}
#status.error{background:#3a1a1a;border:1px solid #f77;color:#f99;display:block;}
.patients-grid{display:grid;gap:10px;margin-top:14px;}
.patient-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:grid;grid-template-columns:180px 1fr 1fr;gap:14px;align-items:start;transition:border-color .2s;}
.patient-card:hover{border-color:var(--accent);}
.pname{font-weight:600;font-size:14px;}
.ptime{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent2);margin-top:3px;}
.pfield label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:3px;display:block;font-family:'IBM Plex Mono',monospace;}
.pfield p{font-size:12px;line-height:1.5;}
.tag{display:inline-block;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:1px 7px;font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--accent);margin:2px 2px 2px 0;}
.actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
.divider{height:1px;background:var(--border);margin:28px 0;}
.privacy-note{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 15px;font-size:11px;color:var(--muted);display:flex;align-items:flex-start;gap:9px;margin-bottom:20px;}
.privacy-note .icon{color:var(--accent2);font-size:15px;margin-top:-1px;flex-shrink:0;}
#pcount{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--muted);margin-top:6px;}
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);}
.empty-state .icon{font-size:44px;margin-bottom:10px;}
.empty-state p{font-size:13px;}
</style>
</head>
<body>
<header>
  <div class="logo">TC</div>
  <div>
    <h1>Generatore Protocolli TC</h1>
    <div class="sub">ASST Brianza ‚Äì Desio</div>
  </div>
  <div class="badge">üîí 100% locale ‚Äì nessun dato inviato</div>
</header>
<main>
  <div class="privacy-note">
    <span class="icon">üõ°Ô∏è</span>
    <span>Tutto il processing avviene <strong>esclusivamente nel tuo browser</strong>. Nessun dato paziente viene trasmesso a server esterni. Sicuro per reti ospedaliere.</span>
  </div>

  <div class="step" style="margin-bottom:28px">
    <div class="step-label">Step 01</div>
    <h2>Carica la lista giornaliera</h2>
    <div class="upload-zone" id="dropzone">
      <input type="file" id="pdf-input" accept=".pdf">
      <div class="upload-icon">üìã</div>
      <p>Trascina il PDF della lista esami, oppure <strong>clicca per selezionarlo</strong></p>
      <p style="margin-top:7px;font-size:11px;font-family:'IBM Plex Mono',monospace;">Formato: Lista esami da eseguire ‚Äì RIS Desio</p>
    </div>
    <div id="status"></div>
  </div>

  <div class="divider"></div>

  <div class="step">
    <div class="step-label">Step 02</div>
    <h2>Pazienti estratti</h2>
    <div id="pcount"></div>
    <div class="patients-grid" id="plist">
      <div class="empty-state"><div class="icon">‚¨ÜÔ∏è</div><p>Carica un PDF per vedere i pazienti estratti</p></div>
    </div>
    <div class="actions" id="actions" style="display:none">
      <button class="btn btn-green" onclick="generatePDF()">üñ®Ô∏è Genera PDF protocolli da stampare</button>
      <button class="btn btn-sec" onclick="resetAll()">‚Ü∫ Ricomincia</button>
    </div>
  </div>
</main>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let patients = [];

// Drag & drop
const dropzone = document.getElementById('dropzone');
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if (f) processPDF(f); });
document.getElementById('pdf-input').addEventListener('change', e => { if (e.target.files[0]) processPDF(e.target.files[0]); });

function setStatus(msg, type) { const el = document.getElementById('status'); el.textContent = msg; el.className = type; }

async function processPDF(file) {
  setStatus('‚è≥ Lettura PDF in corso...', 'info');
  try {
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      // Reconstruct lines: pdfjs returns items with x,y positions
      // Group items by y-position to form lines
      const items = content.items;
      const lineMap = {};
      items.forEach(item => {
        const yKey = Math.round(item.transform[5]);
        if (!lineMap[yKey]) lineMap[yKey] = [];
        lineMap[yKey].push(item.str);
      });
      // Sort by y descending (top to bottom) and join
      const sortedYs = Object.keys(lineMap).map(Number).sort((a,b) => b - a);
      sortedYs.forEach(y => {
        fullText += lineMap[y].join(' ').trim() + '\n';
      });
    }
    patients = parsePatients(fullText);
    if (patients.length === 0) { setStatus('‚ö†Ô∏è Nessun paziente trovato. Verifica il formato del PDF.', 'error'); return; }
    setStatus(`‚úì Estratti ${patients.length} pazienti con successo`, 'success');
    renderPatients(patients);
    document.getElementById('actions').style.display = 'flex';
  } catch(e) { setStatus('‚ùå Errore: ' + e.message, 'error'); console.error(e); }
}

// ‚îÄ‚îÄ PARSER ‚îÄ‚îÄ
function parsePatients(rawText) {
  const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  const startIdxs = [];
  lines.forEach((l, i) => { if (/^0D\d{8}/.test(l)) startIdxs.push(i); });
  const result = [];
  startIdxs.forEach((si, bi) => {
    const ei = bi + 1 < startIdxs.length ? startIdxs[bi + 1] : lines.length;
    const block = lines.slice(si, ei);
    const pt = parseBlock(block);
    if (pt && pt.name) result.push(pt);
  });
  return result;
}

function parseBlock(lines) {
  const line0 = lines[0] || '';
  const line1 = lines[1] || '';
  const line2 = lines[2] || '';

  // Time
  const timeM = line1.match(/(\d{2}:\d{2})/);
  const time = timeM ? timeM[1] : '';

  // Surname (between the two dates on line0)
  const surnameM = line0.match(/\d{2}\/\d{2}\/\d{4}\s+([A-Z√Ä√à√å√í√ô]+(?:\s+[A-Z√Ä√à√å√í√ô]+)*?)\s+\d{2}\/\d{2}\/\d{4}/);
  const surname = surnameM ? surnameM[1].trim() : '';

  // Given name: after HH:MM, before DESIO
  let given = '';
  const gm1 = line1.match(/\d{2}:\d{2}\s+([A-Z√Ä√à√å√í√ôA-Za-z]+(?:\s+[A-Z√Ä√à√å√í√ôA-Za-z]+)*?)\s+DESIO/);
  if (gm1) {
    given = gm1[1].trim();
    // Check if line2 starts with a short continuation (truncated name e.g. "A ONCOLOGI")
    const contM = line2.match(/^([A-Z√Ä√à√å√í√ô]{1,4})\s+(ONCOLOGI|MEDICINA|BASE|DH|C\/S|TAC|ONE|DIRETTA)/);
    if (contM) given = given + contM[1];
  } else {
    // Name might be split differently ‚Äî try extracting partial from line1
    const pm = line1.match(/\d{2}:\d{2}\s+([A-Z√Ä√à√å√í√ô]+)/);
    if (pm) {
      given = pm[1];
      // Check line2 for continuation before DESIO
      const cont2 = line2.match(/^([A-Z√Ä√à√å√í√ô]{1,5})\s+DESIO/);
      if (cont2) given = given + cont2[1];
      else {
        // line2: "A ONCOLOGI Nessuna" pattern
        const cont3 = line2.match(/^([A-Z√Ä√à√å√í√ô]{1,4})\s+(ONCOLOGI|MEDICINA|BASE|DH)/);
        if (cont3) given = given + cont3[1];
      }
    }
  }

  const name = surname + (given ? ' ' + given : '');

  // Noise patterns for indication extraction
  const NOISE_RE = /^(0D|Codice|Descrizione|Stato esame|Tariffario|Dose|Lista esami|Richieste|errori|TAC \d|DESIO|DES-RAD|Prenotato|Nessuna|MDC|URG|1A|ONCOLOGI|ONE DIRETTA|DIRETTA|ACCETTAZI|CUP|TAC BASE|TAC C\/S|TAC DH|TAC ONCOLOGI|MEDICINA|\d{2}\/\d{2}\/\d{4}|\d{2}:\d{2}|\d{5,}|pviggiano|Of \d)/i;
  const NOISE_EXACT = new Set(['A','ONE','DIRETTA','CUP','URG','1A','MEDICINA','ONCOLOGI','TAC BASE URG','MDC URG','MDC 1A','Nessuna','Da eseguire']);

  let indication = '';
  for (const line of lines.slice(2)) {
    const l = line.trim();
    if (!l || l.length < 5) continue;
    if (NOISE_EXACT.has(l)) continue;
    if (NOISE_RE.test(l)) continue;
    if (/^[A-Z]{1,3}\s+(ONCOLOGI|MEDICINA|BASE|DH|C\/S)/.test(l)) continue;
    if (l === surname || l === given || l === name) continue;
    indication = l;
    break;
  }

  // Exams
  const exams = [];
  const EXAM_EXCLUDE = /^TAC (2|BASE|C\/S|DH|ONCOLOG)/;
  lines.forEach(l => {
    // Lines like "TAC TORACE CON CONTRASTO ... Da eseguire" or just the description
    const m = l.match(/^(TAC [A-Z√Ä√à√å√í√ô][A-Z√Ä√à√å√í√ôA-Za-z\s,\(\)\.\/\-]+?)(?:\s+Da eseguire)?$/);
    if (m) {
      const exam = m[1].trim();
      if (exam.length > 7 && !EXAM_EXCLUDE.test(exam) && !exams.includes(exam)) {
        exams.push(exam);
      }
    }
  });

  return { name, time, indication, exams };
}

function renderPatients(pts) {
  const c = document.getElementById('plist');
  c.innerHTML = '';
  document.getElementById('pcount').textContent = pts.length + ' pazienti trovati';
  pts.forEach(p => {
    const card = document.createElement('div');
    card.className = 'patient-card';
    const examsHtml = p.exams.map(e => `<span class="tag">${e}</span>`).join('') || '<span style="color:var(--muted)">‚Äî</span>';
    card.innerHTML = `
      <div><div class="pname">${p.name}</div><div class="ptime">‚è∞ ${p.time||'‚Äî'}</div></div>
      <div class="pfield"><label>Esami richiesti</label><p>${examsHtml}</p></div>
      <div class="pfield"><label>Quesito diagnostico</label><p>${p.indication||'<span style="color:var(--muted)">‚Äî</span>'}</p></div>`;
    c.appendChild(card);
  });
}

function resetAll() {
  patients = [];
  document.getElementById('plist').innerHTML = '<div class="empty-state"><div class="icon">‚¨ÜÔ∏è</div><p>Carica un PDF per vedere i pazienti estratti</p></div>';
  document.getElementById('actions').style.display = 'none';
  document.getElementById('status').className = '';
  document.getElementById('pcount').textContent = '';
  document.getElementById('pdf-input').value = '';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PDF GENERATION ‚Äì A4 landscape, 3 patients/page
// Layout: [Nome+Orario | Esami | Quesito] [Info Cliniche] [Basale] [Arteriosa] [Venosa] [Eq.Tardiva]
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generatePDF() {
  if (!patients.length) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
  const PW = 297, PH = 210, M = 7;
  const totalPages = Math.ceil(patients.length / 3);

  for (let pi = 0; pi < totalPages; pi++) {
    if (pi > 0) doc.addPage();
    const batch = patients.slice(pi * 3, pi * 3 + 3);
    const rH = (PH - M * 2) / 3;

    doc.setFontSize(6); doc.setTextColor(150,150,150); doc.setFont('helvetica','normal');
    doc.text(`Protocolli TC ‚Äì ${new Date().toLocaleDateString('it-IT')} ‚Äì Pag. ${pi+1}/${totalPages}`, PW - M, M - 1.5, {align:'right'});

    batch.forEach((pt, ri) => drawRow(doc, pt, M + ri * rH, rH, PW, M));
  }

  doc.save(`protocolli_tc_${new Date().toISOString().slice(0,10)}.pdf`);
  setStatus(`‚úì PDF generato con ${patients.length} pazienti. Download avviato!`, 'success');
}

function drawRow(doc, pt, y, rH, PW, M) {
  const W = PW - M * 2;
  const iH = rH - 1.5;
  const x = M;

  // Column widths (mm)
  const cLeft = 46;   // nome+esami+quesito
  const cInfo = 33;   // info cliniche
  const cPh = (W - cLeft - cInfo) / 4; // 4 phases

  const HDR = 5.5;
  const bodyY = y + HDR;
  const bodyH = iH - HDR;

  // Color palette
  const G=[45,106,79], B=[30,58,95], R=[123,45,45];
  const LG=[220,237,228], LB=[210,225,245], LR=[245,210,210];
  const LGRAY=[248,248,248], MGRAY=[195,195,195], DGRAY=[90,90,90], BLK=[15,15,15];

  // Outer border
  doc.setDrawColor(160,160,160); doc.setLineWidth(0.3);
  doc.rect(x, y, W, iH);

  // ‚îÄ‚îÄ HEADER ROW ‚îÄ‚îÄ
  // Left cols header (green)
  doc.setFillColor(...G); doc.rect(x, y, cLeft + cInfo, HDR, 'F');
  // Phase headers
  [[G,0],[B,1],[B,2],[R,3]].forEach(([col,i]) => {
    doc.setFillColor(...col);
    doc.rect(x + cLeft + cInfo + i * cPh, y, cPh, HDR, 'F');
  });
  doc.setFontSize(5.8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('PAZIENTE / ESAMI / QUESITO', x + (cLeft + cInfo) / 2, y + HDR/2 + 1, {align:'center'});
  ['BASALE','ARTERIOSA','VENOSA','EQ. TARDIVA'].forEach((lbl,i) => {
    doc.text(lbl, x + cLeft + cInfo + (i+0.5)*cPh, y + HDR/2 + 1, {align:'center'});
  });

  // ‚îÄ‚îÄ LEFT COLUMN (3 sub-sections) ‚îÄ‚îÄ
  const nameH = bodyH * 0.36;
  const examH = bodyH * 0.36;
  const questH = bodyH - nameH - examH;

  // Name section
  doc.setFillColor(...LG); doc.rect(x, bodyY, cLeft, nameH, 'F');
  doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(...BLK);
  const nLines = doc.splitTextToSize(pt.name, cLeft - 3);
  doc.text(nLines.slice(0,2), x + 1.5, bodyY + 4);
  if (pt.time) {
    doc.setFontSize(6); doc.setFont('helvetica','normal'); doc.setTextColor(...DGRAY);
    doc.text('Ore ' + pt.time, x + 1.5, bodyY + nameH - 2);
  }

  doc.setDrawColor(...MGRAY); doc.setLineWidth(0.15);
  doc.line(x, bodyY + nameH, x + cLeft, bodyY + nameH);

  // Exam section
  doc.setFillColor(255,255,255); doc.rect(x, bodyY + nameH, cLeft, examH, 'F');
  doc.setFontSize(5.8); doc.setFont('helvetica','normal'); doc.setTextColor(...BLK);
  if (pt.exams.length) {
    const eLines = doc.splitTextToSize(pt.exams.join('\n'), cLeft - 3);
    doc.text(eLines.slice(0,6), x + 1.5, bodyY + nameH + 3.5);
  }

  doc.setDrawColor(...MGRAY); doc.line(x, bodyY + nameH + examH, x + cLeft, bodyY + nameH + examH);

  // Quesito section
  doc.setFillColor(...LGRAY); doc.rect(x, bodyY + nameH + examH, cLeft, questH, 'F');
  doc.setFontSize(5); doc.setFont('helvetica','bold'); doc.setTextColor(...DGRAY);
  doc.text('QUESITO DIAGNOSTICO', x + 1.5, bodyY + nameH + examH + 2.8);
  doc.setFont('helvetica','normal'); doc.setTextColor(...BLK);
  const qLines = doc.splitTextToSize(pt.indication || '‚Äî', cLeft - 3);
  doc.text(qLines.slice(0,3), x + 1.5, bodyY + nameH + examH + 6);

  // ‚îÄ‚îÄ INFO CLINICHE ‚îÄ‚îÄ
  const iX = x + cLeft;
  doc.setFillColor(255,255,255); doc.rect(iX, bodyY, cInfo, bodyH, 'F');
  doc.setDrawColor(...MGRAY); doc.setLineWidth(0.2);
  doc.line(iX, y, iX, y + iH);

  let iy = bodyY + 4.5;
  doc.setFontSize(5.8); doc.setFont('helvetica','bold'); doc.setTextColor(...DGRAY);
  const ll = cInfo - 3.5;

  doc.text('TC prec?', iX + 1.5, iy);
  doc.setLineWidth(0.18); doc.setDrawColor(175,175,175);
  doc.line(iX + 13, iy + 0.3, iX + ll, iy + 0.3);
  iy += 5.5;

  doc.text('GFR?', iX + 1.5, iy);
  doc.line(iX + 9, iy + 0.3, iX + ll, iy + 0.3);
  iy += 5.5;

  doc.text('Altre info:', iX + 1.5, iy);
  iy += 4;
  for (let li = 0; li < 4; li++) {
    doc.line(iX + 1.5, iy, iX + ll, iy);
    iy += 4.5;
  }

  // ‚îÄ‚îÄ PHASE COLUMNS ‚îÄ‚îÄ
  const districts = ['ENC','Collo','ADs','ADc','TAs','TAc'];
  const phaseBg = [LG, LB, LB, LR];
  const phaseXs = [0,1,2,3].map(i => x + cLeft + cInfo + i * cPh);

  phaseXs.forEach((px, pi) => {
    doc.setFillColor(...phaseBg[pi]);
    doc.rect(px, bodyY, cPh, bodyH, 'F');
    doc.setDrawColor(...MGRAY); doc.setLineWidth(0.25);
    doc.line(px, y, px, y + iH);

    const lblX = px + 1.5;
    const cbSz = 3;
    const cbX = px + cPh - cbSz - 1.5;
    let cy = bodyY + 3;

    // Arteriosa & Venosa: Flu/Vol lines
    if (pi === 1 || pi === 2) {
      doc.setFontSize(5.5); doc.setFont('helvetica','normal'); doc.setTextColor(...DGRAY);
      doc.text('Flu.', lblX, cy + 2.2);
      doc.setLineWidth(0.15); doc.setDrawColor(175,175,175);
      doc.line(lblX + 6.5, cy + 2.2, px + cPh - 1.5, cy + 2.2);
      cy += 4.5;
      doc.text('Vol.', lblX, cy + 2.2);
      doc.line(lblX + 6.5, cy + 2.2, px + cPh - 1.5, cy + 2.2);
      cy += 4.5;
      doc.setDrawColor(...MGRAY); doc.setLineWidth(0.15);
      doc.line(px, cy - 0.5, px + cPh, cy - 0.5);
    }

    // EQ. TARDIVA: special layout with min fields
    if (pi === 3) {
      const minD = ['ADs','ADc','TAs','TAc'];
      const sp = bodyH / (minD.length + 1.5);
      minD.forEach((d, di) => {
        const ry = bodyY + 3 + di * sp;
        doc.setFontSize(5.5); doc.setFont('helvetica','normal'); doc.setTextColor(...BLK);
        doc.text(d, lblX, ry + 2.2);
        doc.text('min', lblX + 7.5, ry + 2.2);
        doc.setLineWidth(0.15); doc.setDrawColor(175,175,175);
        doc.line(lblX + 14, ry + 2.2, px + cPh - 1.5, ry + 2.2);
      });
      // ENC checkbox
      const encY = bodyY + 3 + minD.length * sp;
      doc.setFontSize(5.5); doc.setFont('helvetica','normal'); doc.setTextColor(...BLK);
      doc.text('ENC', lblX, encY + 2.2);
      doc.setFillColor(252,252,252); doc.setDrawColor(130,130,130); doc.setLineWidth(0.3);
      doc.rect(cbX, encY + 0.3, cbSz, cbSz, 'FD');
      return;
    }

    // Normal districts with checkboxes
    const avail = bodyH - (cy - bodyY);
    const sp2 = avail / districts.length;
    districts.forEach((d, di) => {
      const ry = cy + di * sp2;
      doc.setFontSize(5.8); doc.setFont('helvetica','normal'); doc.setTextColor(...BLK);
      doc.text(d, lblX, ry + 2.5);
      doc.setFillColor(252,252,252); doc.setDrawColor(130,130,130); doc.setLineWidth(0.3);
      doc.rect(cbX, ry + 0.3, cbSz, cbSz, 'FD');
    });
  });

  // Close right border
  doc.setDrawColor(160,160,160); doc.setLineWidth(0.3);
  doc.line(x + W, y, x + W, y + iH);
}
</script>
</body>
</html>